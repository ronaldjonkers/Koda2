<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koda2 Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg-0:#09090b;--bg-1:#111113;--bg-2:#18181b;--bg-3:#222225;--bg-4:#2c2c30;
  --tx-0:#fafafa;--tx-1:#a1a1aa;--tx-2:#71717a;--tx-3:#52525b;
  --accent:#6366f1;--accent-h:#818cf8;--accent-dim:rgba(99,102,241,.12);
  --green:#22c55e;--green-dim:rgba(34,197,94,.12);
  --amber:#f59e0b;--amber-dim:rgba(245,158,11,.12);
  --red:#ef4444;--red-dim:rgba(239,68,68,.12);
  --blue:#3b82f6;--blue-dim:rgba(59,130,246,.12);
  --border:rgba(255,255,255,.07);
  --r-sm:8px;--r-md:12px;--r-lg:16px;
  --tr:.15s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-0);color:var(--tx-0);line-height:1.5;min-height:100vh;-webkit-font-smoothing:antialiased}
button{font-family:inherit;cursor:pointer}input,textarea,select{font-family:inherit}
a{color:var(--accent-h);text-decoration:none}
code{font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--bg-3);padding:2px 6px;border-radius:4px}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{display:grid;grid-template-columns:220px 1fr;min-height:100vh}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{background:var(--bg-1);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;z-index:100}
.sidebar-top{flex:1;overflow-y:auto;padding:16px 10px 10px}
.logo{display:flex;align-items:center;gap:10px;padding:4px 8px 18px}
.logo-mark{width:30px;height:30px;background:linear-gradient(135deg,var(--accent),#a78bfa);border-radius:var(--r-sm);display:grid;place-items:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0}
.logo h1{font-size:17px;font-weight:700;letter-spacing:-.3px}
.logo small{font-size:10px;color:var(--tx-3);font-weight:400;margin-left:3px}
.nav-group{margin-bottom:14px}
.nav-group-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--tx-3);padding:0 10px;margin-bottom:4px}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:var(--r-sm);color:var(--tx-1);font-size:12.5px;font-weight:500;transition:all var(--tr);border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--bg-2);color:var(--tx-0)}
.nav-item.active{background:var(--accent-dim);color:var(--accent-h)}
.nav-item .ic{width:16px;text-align:center;font-size:13px;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;line-height:14px}
.sidebar-bottom{padding:10px 12px;border-top:1px solid var(--border);flex-shrink:0}
.conn-row{display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--tx-2);padding:3px 0}
.conn-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green)}
.conn-dot.off{background:var(--red);box-shadow:0 0 5px var(--red)}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{padding:24px 32px 32px;min-height:100vh;min-width:0}
.page-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px}
.page-head h2{font-size:20px;font-weight:700;letter-spacing:-.3px}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:var(--r-sm);font-size:12px;font-weight:500;border:none;transition:all var(--tr);white-space:nowrap}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent-h)}
.btn-ghost{background:var(--bg-2);color:var(--tx-1);border:1px solid var(--border)}.btn-ghost:hover{background:var(--bg-3);color:var(--tx-0)}
.btn-sm{padding:5px 10px;font-size:11px}

/* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.stat{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);padding:16px 18px;position:relative;overflow:hidden}
.stat::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat:nth-child(1)::after{background:var(--accent)}.stat:nth-child(2)::after{background:var(--blue)}
.stat:nth-child(3)::after{background:var(--green)}.stat:nth-child(4)::after{background:var(--amber)}
.stat-label{font-size:10px;color:var(--tx-2);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.stat-val{font-size:24px;font-weight:700;line-height:1.1;margin-bottom:2px}
.stat-sub{font-size:11px;color:var(--tx-2)}

/* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.grid-main{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-bottom:16px}
.panel{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);overflow:hidden;display:flex;flex-direction:column;min-width:0}
.panel-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:8px}
.panel-head h3{font-size:13px;font-weight:600;white-space:nowrap}
.panel-body{flex:1;overflow-y:auto;max-height:320px}
.panel-body.pad{padding:14px 16px}
.panel-body.tall{max-height:calc(100vh - 200px)}

/* â”€â”€ Resource bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px 16px}
.res{background:var(--bg-2);border-radius:var(--r-sm);padding:12px}
.res-label{font-size:10px;color:var(--tx-2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.res-val{font-size:16px;font-weight:600;margin-bottom:6px}
.res-bar{height:3px;background:var(--bg-4);border-radius:2px;overflow:hidden}
.res-bar-fill{height:100%;border-radius:2px;transition:width .4s ease}

/* â”€â”€ Service list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.svc-list{padding:6px 8px}
.svc{display:flex;align-items:center;gap:9px;padding:8px 8px;border-radius:var(--r-sm)}
.svc:hover{background:var(--bg-2)}
.svc-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;font-size:14px;flex-shrink:0}
.svc-icon.on{background:var(--green-dim)}.svc-icon.off{background:var(--bg-3)}
.svc-info{flex:1;min-width:0}
.svc-name{font-size:12px;font-weight:500}.svc-status{font-size:10px;color:var(--tx-2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.svc-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.svc-dot.on{background:var(--green)}.svc-dot.off{background:var(--tx-3)}

/* â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.task{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);transition:background var(--tr)}
.task:last-child{border-bottom:none}.task:hover{background:var(--bg-2)}
.task-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.task-dot.pending{background:var(--amber)}.task-dot.running{background:var(--blue);animation:blink 1.4s infinite}
.task-dot.completed{background:var(--green)}.task-dot.failed{background:var(--red)}.task-dot.cancelled{background:var(--tx-3)}
.task-filter{background:var(--bg-2);border:1px solid var(--border);color:var(--tx-2);font-size:10px;padding:3px 10px;border-radius:12px;cursor:pointer;transition:all var(--tr)}
.task-filter:hover{background:var(--bg-3)}.task-filter.active{background:var(--accent-dim);color:var(--accent-h);border-color:var(--accent)}
.task-actions{display:flex;gap:4px;align-items:center;flex-shrink:0}
.task-cancel{background:none;border:1px solid var(--border);color:var(--tx-2);font-size:9px;padding:2px 8px;border-radius:4px;cursor:pointer;transition:all var(--tr)}
.task-cancel:hover{border-color:var(--red);color:var(--red)}
.task-status{font-size:9px;padding:1px 6px;border-radius:8px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.task-status.running{background:rgba(59,130,246,.15);color:var(--blue)}.task-status.completed{background:rgba(34,197,94,.15);color:var(--green)}
.task-status.failed{background:rgba(239,68,68,.15);color:var(--red)}.task-status.pending{background:rgba(245,158,11,.15);color:var(--amber)}
.task-status.cancelled{background:rgba(100,116,139,.15);color:var(--tx-3)}
.task-error{font-size:10px;color:var(--red);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.task-body{flex:1;min-width:0}
.task-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.task-meta{font-size:10px;color:var(--tx-2)}
.task-prog{width:80px;flex-shrink:0}
.prog-bar{height:3px;background:var(--bg-3);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-h));border-radius:2px;transition:width .3s}
.prog-pct{font-size:9px;color:var(--tx-2);text-align:right;margin-top:2px}

/* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 100px)}
.chat-messages{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:10px}
.chat-msg{max-width:82%;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.user{align-self:flex-end}.chat-msg.assistant{align-self:flex-start}
.chat-bubble{padding:9px 13px;border-radius:var(--r-md);font-size:13px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap}
.chat-msg.user .chat-bubble{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.chat-msg.assistant .chat-bubble{background:var(--bg-2);color:var(--tx-0);border:1px solid var(--border);border-bottom-left-radius:4px}
.chat-msg .chat-time{font-size:9px;color:var(--tx-3);margin-top:3px;padding:0 4px}
.chat-msg.user .chat-time{text-align:right}
.chat-typing{align-self:flex-start}
.chat-typing .chat-bubble{display:flex;gap:4px;padding:11px 16px}
.typing-dot{width:5px;height:5px;border-radius:50%;background:var(--tx-2);animation:bounce .6s infinite alternate}
.typing-dot:nth-child(2){animation-delay:.15s}.typing-dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{from{opacity:.3;transform:translateY(0)}to{opacity:1;transform:translateY(-3px)}}
.chat-input-area{padding:10px 14px;border-top:1px solid var(--border);background:var(--bg-1);flex-shrink:0}
.chat-input-wrap{display:flex;gap:8px;align-items:flex-end}
.chat-input{flex:1;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-md);padding:9px 12px;color:var(--tx-0);font-size:13px;resize:none;outline:none;max-height:100px;min-height:38px;line-height:1.4;transition:border-color var(--tr)}
.chat-input:focus{border-color:var(--accent)}.chat-input::placeholder{color:var(--tx-3)}
.chat-send{width:36px;height:36px;border-radius:var(--r-sm);background:var(--accent);color:#fff;border:none;display:grid;place-items:center;transition:all var(--tr);flex-shrink:0}
.chat-send:hover{background:var(--accent-h)}.chat-send:disabled{opacity:.35;cursor:not-allowed}
.chat-send svg{width:16px;height:16px}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:36px 20px;color:var(--tx-2)}
.empty-icon{font-size:28px;margin-bottom:8px;opacity:.4}
.empty-title{font-size:13px;font-weight:600;color:var(--tx-1);margin-bottom:3px}
.empty p{font-size:11px}

/* â”€â”€ Data rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.data-row{display:flex;align-items:center;gap:10px;padding:9px 16px;border-bottom:1px solid var(--border);transition:background var(--tr);font-size:12px}
.data-row:last-child{border-bottom:none}.data-row:hover{background:var(--bg-2)}
.tag{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;white-space:nowrap}
.tag-green{background:var(--green-dim);color:var(--green)}
.tag-red{background:var(--red-dim);color:var(--red)}
.tag-blue{background:var(--blue-dim);color:var(--blue)}
.tag-amber{background:var(--amber-dim);color:var(--amber)}
.tag-gray{background:var(--bg-3);color:var(--tx-2)}

/* â”€â”€ Calendar events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.evt{display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border)}
.evt:last-child{border-bottom:none}.evt:hover{background:var(--bg-2)}
.evt-time{font-size:11px;color:var(--accent-h);font-weight:600;min-width:46px;flex-shrink:0;padding-top:1px}
.evt-info{flex:1;min-width:0}
.evt-title{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.evt-loc{font-size:10px;color:var(--tx-2)}
.evt-cal{font-size:9px;padding:1px 6px;border-radius:3px;font-weight:600;white-space:nowrap;flex-shrink:0}
.evt-cal-google{background:var(--blue-dim);color:var(--blue)}
.evt-cal-ews{background:var(--amber-dim);color:var(--amber)}
.evt-cal-msgraph{background:var(--green-dim);color:var(--green)}
.evt-cal-caldav{background:var(--bg-3);color:var(--tx-2)}

/* â”€â”€ Account rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.acc{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border)}
.acc:last-child{border-bottom:none}.acc:hover{background:var(--bg-2)}
.acc-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;font-size:14px;flex-shrink:0;background:var(--bg-3)}
.acc-info{flex:1;min-width:0}
.acc-name{font-size:12px;font-weight:500}.acc-detail{font-size:10px;color:var(--tx-2)}

/* â”€â”€ Scheduler rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sched{display:flex;align-items:center;gap:10px;padding:9px 16px;border-bottom:1px solid var(--border);font-size:12px}
.sched:last-child{border-bottom:none}.sched:hover{background:var(--bg-2)}
.sched-name{flex:1;min-width:0;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sched-meta{font-size:10px;color:var(--tx-2);flex-shrink:0}

/* â”€â”€ Integrations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.int-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px}
.int-card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-md);padding:16px;transition:border-color var(--tr)}
.int-card:hover{border-color:rgba(99,102,241,.2)}
.int-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.int-icon{width:34px;height:34px;border-radius:var(--r-sm);display:grid;place-items:center;font-size:17px;flex-shrink:0}
.int-title{font-size:13px;font-weight:600}.int-desc{font-size:10px;color:var(--tx-2);margin-top:1px}

/* â”€â”€ Search bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar{display:flex;gap:8px;margin-bottom:14px}
.search-input{flex:1;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:8px 12px;color:var(--tx-0);font-size:12px;outline:none;transition:border-color var(--tr)}
.search-input:focus{border-color:var(--accent)}.search-input::placeholder{color:var(--tx-3)}

/* â”€â”€ Section visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section{display:none}.section.active{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-4);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--tx-3)}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:1100px){.stats{grid-template-columns:repeat(2,1fr)}.grid-main{grid-template-columns:1fr 280px}.grid-2{grid-template-columns:1fr}}
@media(max-width:900px){.grid-main{grid-template-columns:1fr}}
@media(max-width:768px){.app{grid-template-columns:1fr}.sidebar{display:none}.main{padding:14px}.stats{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.stats{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

<!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<aside class="sidebar">
  <div class="sidebar-top">
    <div class="logo"><div class="logo-mark">K</div><h1>Koda2<small>AI</small></h1></div>
    <nav>
      <div class="nav-group">
        <div class="nav-group-label">Main</div>
        <button class="nav-item active" data-section="dashboard"><span class="ic">ğŸ“Š</span>Dashboard</button>
        <button class="nav-item" data-section="chat"><span class="ic">ğŸ’¬</span>Chat</button>
        <button class="nav-item" data-section="tasks"><span class="ic">âš¡</span>Tasks<span class="nav-badge" id="tasks-badge" style="display:none">0</span></button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">Data</div>
        <button class="nav-item" data-section="calendar"><span class="ic">ğŸ“…</span>Calendar</button>
        <button class="nav-item" data-section="email"><span class="ic">ğŸ“§</span>Email</button>
        <button class="nav-item" data-section="contacts"><span class="ic">ğŸ‘¥</span>Contacts</button>
        <button class="nav-item" data-section="memory"><span class="ic">ğŸ§ </span>Memory</button>
      </div>
      <div class="nav-group">
        <div class="nav-group-label">System</div>
        <button class="nav-item" data-section="integrations"><span class="ic">ğŸ”Œ</span>Integrations</button>
        <button class="nav-item" data-section="accounts"><span class="ic">ğŸ‘¤</span>Accounts</button>
        <button class="nav-item" data-section="scheduler"><span class="ic">â°</span>Scheduler</button>
        <button class="nav-item" data-section="supervisor"><span class="ic">ğŸ§¬</span>Supervisor</button>
      </div>
    </nav>
  </div>
  <div class="sidebar-bottom">
    <div class="conn-row"><span>WebSocket</span><span style="display:flex;align-items:center;gap:5px"><span class="conn-dot off" id="ws-dot"></span><span id="ws-label">...</span></span></div>
    <div class="conn-row"><span>API</span><span style="display:flex;align-items:center;gap:5px"><span class="conn-dot off" id="api-dot"></span><span id="api-label">...</span></span></div>
  </div>
</aside>

<!-- â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="main">

<!-- â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section active" id="section-dashboard">
  <div class="page-head">
    <h2>Dashboard</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="refreshAll()">Refresh</button>
      <button class="btn btn-primary btn-sm" onclick="nav('chat')">Open Chat</button>
    </div>
  </div>
  <div class="stats">
    <div class="stat"><div class="stat-label">Active Tasks</div><div class="stat-val" id="s-tasks">0</div><div class="stat-sub">processing</div></div>
    <div class="stat"><div class="stat-label">Messages</div><div class="stat-val" id="s-msgs">0</div><div class="stat-sub"><span id="s-rate">0</span>/min</div></div>
    <div class="stat"><div class="stat-label">CPU</div><div class="stat-val" id="s-cpu">0%</div><div class="stat-sub"><span id="s-ram">0</span> MB RAM</div></div>
    <div class="stat"><div class="stat-label">Uptime</div><div class="stat-val" id="s-up">--</div><div class="stat-sub" id="s-plat">--</div></div>
  </div>
  <div class="grid-main">
    <div style="display:flex;flex-direction:column;gap:14px">
      <!-- Active Tasks -->
      <div class="panel" style="flex:1">
        <div class="panel-head"><h3>Active Tasks</h3><button class="btn btn-ghost btn-sm" onclick="nav('tasks')">View all</button></div>
        <div class="panel-body" id="dash-tasks"><div class="empty"><div class="empty-icon">âš¡</div><div class="empty-title">No active tasks</div><p>Tasks appear when the assistant is working</p></div></div>
      </div>
      <!-- Upcoming Events -->
      <div class="panel">
        <div class="panel-head"><h3>Upcoming Events</h3><button class="btn btn-ghost btn-sm" onclick="nav('calendar')">Calendar</button></div>
        <div class="panel-body" id="dash-events"><div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No upcoming events</div></div></div>
      </div>
      <!-- System Resources -->
      <div class="panel">
        <div class="panel-head"><h3>System Resources</h3></div>
        <div class="res-grid">
          <div class="res"><div class="res-label">CPU</div><div class="res-val" id="r-cpu">0%</div><div class="res-bar"><div class="res-bar-fill" id="r-cpu-bar" style="width:0%;background:var(--accent)"></div></div></div>
          <div class="res"><div class="res-label">Memory</div><div class="res-val" id="r-mem">0%</div><div class="res-bar"><div class="res-bar-fill" id="r-mem-bar" style="width:0%;background:var(--accent-h)"></div></div></div>
          <div class="res"><div class="res-label">Disk</div><div class="res-val" id="r-disk">0%</div><div class="res-bar"><div class="res-bar-fill" id="r-disk-bar" style="width:0%;background:var(--green)"></div></div></div>
          <div class="res"><div class="res-label">Network</div><div class="res-val" id="r-net">0 B/s</div><div class="res-bar"><div class="res-bar-fill" id="r-net-bar" style="width:0%;background:var(--blue)"></div></div></div>
        </div>
      </div>
    </div>
    <!-- Services sidebar -->
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="panel" style="flex:1">
        <div class="panel-head"><h3>Services</h3></div>
        <div class="svc-list" id="svc-list">
          <div class="svc"><div class="svc-icon off">ğŸ¤–</div><div class="svc-info"><div class="svc-name">LLM</div><div class="svc-status" id="svc-llm">...</div></div><div class="svc-dot off" id="d-llm"></div></div>
          <div class="svc"><div class="svc-icon off">ğŸ“…</div><div class="svc-info"><div class="svc-name">Calendar</div><div class="svc-status" id="svc-cal">...</div></div><div class="svc-dot off" id="d-cal"></div></div>
          <div class="svc"><div class="svc-icon off">ğŸ“§</div><div class="svc-info"><div class="svc-name">Email</div><div class="svc-status" id="svc-email">...</div></div><div class="svc-dot off" id="d-email"></div></div>
          <div class="svc"><div class="svc-icon off">ğŸ’¬</div><div class="svc-info"><div class="svc-name">Telegram</div><div class="svc-status" id="svc-tg">...</div></div><div class="svc-dot off" id="d-tg"></div></div>
          <div class="svc"><div class="svc-icon off">ğŸ“±</div><div class="svc-info"><div class="svc-name">WhatsApp</div><div class="svc-status" id="svc-wa">...</div></div><div class="svc-dot off" id="d-wa"></div></div>
          <div class="svc"><div class="svc-icon off">ğŸ”Œ</div><div class="svc-info"><div class="svc-name">Plugins</div><div class="svc-status" id="svc-plug">...</div></div><div class="svc-dot off" id="d-plug"></div></div>
          <div class="svc"><div class="svc-icon off">â°</div><div class="svc-info"><div class="svc-name">Scheduler</div><div class="svc-status" id="svc-sched">...</div></div><div class="svc-dot off" id="d-sched"></div></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• CHAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-chat">
  <div class="page-head"><h2>Chat with Koda2</h2></div>
  <div class="panel chat-wrap">
    <div class="chat-messages" id="chat-messages">
      <div class="chat-msg assistant"><div class="chat-bubble">Hello! I'm Koda2, your AI executive assistant. How can I help you today?</div><div class="chat-time">just now</div></div>
    </div>
    <div class="chat-input-area">
      <div class="chat-input-wrap">
        <textarea class="chat-input" id="chat-input" placeholder="Type a message..." rows="1"></textarea>
        <button class="chat-send" id="chat-send" disabled title="Send">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• TASKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-tasks">
  <div class="page-head"><h2>Tasks</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="loadTasks()">Refresh</button>
    </div>
  </div>
  <div class="task-filters" style="display:flex;gap:4px;padding:0 0 10px">
    <button class="btn btn-sm task-filter active" data-filter="all" onclick="setTaskFilter('all')">All</button>
    <button class="btn btn-sm task-filter" data-filter="running" onclick="setTaskFilter('running')">Running</button>
    <button class="btn btn-sm task-filter" data-filter="completed" onclick="setTaskFilter('completed')">Completed</button>
    <button class="btn btn-sm task-filter" data-filter="failed" onclick="setTaskFilter('failed')">Failed</button>
    <button class="btn btn-sm task-filter" data-filter="cancelled" onclick="setTaskFilter('cancelled')">Cancelled</button>
    <span style="margin-left:auto;font-size:10px;color:var(--tx-3);align-self:center" id="task-count"></span>
  </div>
  <div class="panel"><div class="panel-body tall" id="all-tasks"><div class="empty"><div class="empty-icon">âš¡</div><div class="empty-title">No tasks yet</div><p>Tasks appear as the assistant works</p></div></div></div>
</section>

<!-- â•â•â• CALENDAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-calendar">
  <div class="page-head"><h2>Calendar</h2><button class="btn btn-ghost btn-sm" onclick="loadCalendar()">Refresh</button></div>
  <div class="grid-2">
    <div class="panel"><div class="panel-head"><h3>Upcoming Events (7 days)</h3></div><div class="panel-body tall" id="cal-events"><div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Loading...</div></div></div></div>
    <div class="panel"><div class="panel-head"><h3>Calendars</h3></div><div class="panel-body tall" id="cal-list"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">Loading...</div></div></div></div>
  </div>
</section>

<!-- â•â•â• EMAIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-email">
  <div class="page-head"><h2>Email</h2><button class="btn btn-ghost btn-sm" onclick="loadEmail()">Refresh</button></div>
  <div style="font-size:10px;color:var(--tx-3);padding:0 4px 6px" id="email-summary"></div>
  <div class="panel"><div class="panel-body tall" id="email-inbox"><div class="empty"><div class="empty-icon">ğŸ“§</div><div class="empty-title">Loading...</div></div></div></div>
</section>

<!-- â•â•â• CONTACTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-contacts">
  <div class="page-head"><h2>Contacts</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="syncContacts()">Sync</button>
      <button class="btn btn-ghost btn-sm" onclick="loadContacts()">Refresh</button>
    </div>
  </div>
  <div class="search-bar">
    <input class="search-input" id="contact-q" placeholder="Search contacts by name, email or phone...">
    <button class="btn btn-primary btn-sm" onclick="loadContacts()">Search</button>
  </div>
  <div style="font-size:10px;color:var(--tx-3);padding:0 4px 6px" id="contact-summary"></div>
  <div class="panel"><div class="panel-body tall" id="contact-list"><div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">Loading contacts...</div><p>Syncing from macOS Contacts, WhatsApp, and email accounts</p></div></div></div>
</section>

<!-- â•â•â• MEMORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-memory">
  <div class="page-head"><h2>Memory</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="loadMemory()">Refresh</button>
      <button class="btn btn-primary btn-sm" onclick="toggleMemoryForm()">+ Add Memory</button>
    </div>
  </div>

  <!-- Add memory form (hidden by default) -->
  <div id="mem-form" style="display:none;padding:12px 16px;background:var(--bg-2);border-radius:8px;margin-bottom:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="mem-cat" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg-1);color:var(--tx-1);font-size:12px;min-width:120px">
        <option value="note">Note</option>
        <option value="fact">Fact</option>
        <option value="preference">Preference</option>
        <option value="project">Project</option>
        <option value="contact">Contact</option>
        <option value="habit">Habit</option>
      </select>
      <input id="mem-content" class="search-input" placeholder="What should I remember?" style="flex:1">
      <button class="btn btn-primary btn-sm" onclick="addMemory()">Save</button>
    </div>
  </div>

  <!-- Stats bar -->
  <div style="font-size:10px;color:var(--tx-3);padding:0 4px 6px" id="mem-stats"></div>

  <!-- Search -->
  <div class="search-bar">
    <input class="search-input" id="mem-q" placeholder="Search memories...">
    <button class="btn btn-primary btn-sm" onclick="searchMemory()">Search</button>
  </div>

  <!-- Memory list -->
  <div class="panel"><div class="panel-body tall" id="mem-results"><div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-title">Loading memories...</div></div></div></div>
</section>

<!-- â•â•â• INTEGRATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-integrations">
  <div class="page-head"><h2>Integrations</h2><button class="btn btn-ghost btn-sm" onclick="checkHealth()">Refresh</button></div>
  <div class="int-grid" id="int-grid"></div>
</section>

<!-- â•â•â• ACCOUNTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-accounts">
  <div class="page-head"><h2>Accounts</h2><div style="display:flex;gap:6px"><button class="btn btn-primary btn-sm" onclick="showAddAccount()">+ Add Account</button><button class="btn btn-ghost btn-sm" onclick="loadAccounts()">Refresh</button></div></div>
  <!-- Add account form (hidden by default) -->
  <div class="panel" id="acc-form-panel" style="display:none;margin-bottom:14px">
    <div class="panel-head"><h3>Add Account</h3><button class="btn btn-ghost btn-sm" onclick="hideAddAccount()">Cancel</button></div>
    <div class="panel-body pad" style="max-height:none">
      <div style="margin-bottom:12px">
        <label style="font-size:11px;color:var(--tx-2);display:block;margin-bottom:4px">Account Type</label>
        <select id="acc-provider" class="search-input" style="width:100%" onchange="updateAccFields()">
          <option value="">Select a provider...</option>
          <optgroup label="Google Workspace">
            <option value="google">Google (Calendar + Gmail)</option>
          </optgroup>
          <optgroup label="Microsoft">
            <option value="ews">Exchange (Calendar + Email)</option>
            <option value="msgraph">Office 365 (Calendar + Email)</option>
          </optgroup>
          <optgroup label="Email">
            <option value="imap">IMAP/SMTP Email</option>
          </optgroup>
          <optgroup label="Calendar">
            <option value="caldav">CalDAV (Apple/Nextcloud)</option>
          </optgroup>
        </select>
      </div>
      <div id="acc-name-row" style="margin-bottom:12px">
        <label style="font-size:11px;color:var(--tx-2);display:block;margin-bottom:4px">Account Name</label>
        <input id="acc-name" class="search-input" style="width:100%" placeholder="e.g. Work Exchange, Personal Google">
      </div>
      <div id="acc-fields"></div>
      <div id="acc-default-row" style="display:flex;align-items:center;gap:10px;margin-top:12px">
        <label style="font-size:11px;color:var(--tx-2);display:flex;align-items:center;gap:6px"><input type="checkbox" id="acc-default" checked> Set as default</label>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button class="btn btn-primary btn-sm" id="acc-submit-btn" onclick="submitAccount()">Add Account</button>
        <span id="acc-status" style="font-size:11px;color:var(--tx-2)"></span>
      </div>
    </div>
  </div>
  <div class="panel"><div class="panel-body tall" id="acc-list"><div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">Loading...</div></div></div></div>
</section>

<!-- â•â•â• SCHEDULER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-scheduler">
  <div class="page-head"><h2>Scheduled Jobs</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="loadScheduler()">Refresh</button>
    </div>
  </div>
  <div style="font-size:10px;color:var(--tx-3);padding:0 4px 6px" id="sched-summary"></div>
  <div class="panel"><div class="panel-body tall" id="sched-list"><div class="empty"><div class="empty-icon">â°</div><div class="empty-title">Loading...</div></div></div></div>
</section>

<!-- â•â•â• SUPERVISOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="section" id="section-supervisor">
  <div class="page-head"><h2>ğŸ§¬ Self-Healing Supervisor</h2>
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost btn-sm" onclick="loadSupervisor()">Refresh</button>
    </div>
  </div>

  <!-- Improve form -->
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-body" style="padding:12px">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:600">Request Self-Improvement</h3>
      <p style="font-size:11px;color:var(--tx-3);margin:0 0 8px">Describe what you want Koda2 to improve. The AI will plan changes, modify code, run tests, and commit if successful.</p>
      <div style="display:flex;gap:6px">
        <input id="improve-input" type="text" placeholder="e.g. add a /weather command that shows the forecast" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--bg-2);color:var(--tx-1)">
        <button class="btn btn-primary btn-sm" onclick="submitImprove()" id="improve-btn">Improve</button>
      </div>
      <div id="improve-result" style="margin-top:8px;font-size:11px;display:none"></div>
    </div>
  </div>

  <!-- Improvement Queue -->
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-body" style="padding:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;font-size:13px;font-weight:600">Improvement Queue</h3>
        <div style="display:flex;gap:4px;align-items:center">
          <span id="queue-worker-status" style="font-size:10px;color:var(--tx-3)"></span>
          <button class="btn btn-ghost btn-sm" onclick="toggleQueueWorker()" id="queue-toggle-btn" style="font-size:10px">Start Worker</button>
          <button class="btn btn-ghost btn-sm" onclick="loadQueue()" style="font-size:10px">Refresh</button>
        </div>
      </div>
      <div id="queue-stats" style="font-size:11px;color:var(--tx-2);margin-bottom:8px">Loading...</div>
      <div id="queue-list" style="max-height:300px;overflow-y:auto;font-size:11px">
        <div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No items in queue</div></div>
      </div>
    </div>
  </div>

  <!-- Learning loop -->
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-body" style="padding:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;font-size:13px;font-weight:600">Continuous Learning Loop</h3>
        <button class="btn btn-ghost btn-sm" onclick="triggerLearnCycle()" id="learn-btn" style="font-size:10px">Run Cycle Now</button>
      </div>
      <div id="sv-learner-state" style="font-size:11px;color:var(--tx-2)">Loading...</div>
      <div id="sv-learner-improvements" style="margin-top:6px;font-size:11px"></div>
      <div id="learn-result" style="margin-top:6px;font-size:11px;display:none"></div>
    </div>
  </div>

  <!-- Repair state -->
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-body" style="padding:12px">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:600">Repair State</h3>
      <div id="sv-repair-state" style="font-size:11px;color:var(--tx-2)">Loading...</div>
    </div>
  </div>

  <!-- Audit log -->
  <div class="panel">
    <div class="panel-body" style="padding:12px">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:600">Audit Log</h3>
      <div style="font-size:10px;color:var(--tx-3);margin-bottom:6px" id="sv-audit-summary"></div>
      <div class="panel-body tall" id="sv-audit-list" style="max-height:400px;overflow-y:auto;font-family:monospace;font-size:11px">
        <div class="empty"><div class="empty-icon">ğŸ§¬</div><div class="empty-title">No activity yet</div></div>
      </div>
    </div>
  </div>
</section>

</main>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Koda2 Dashboard â€” JavaScript
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const S = { tasks:[], health:null, ws:false, chatBusy:false };
const T0 = Date.now();

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);
function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function setConn(dotId, lblId, on, txt) { $(dotId).classList.toggle('off', !on); $(lblId).textContent = txt; }

function timeAgo(iso) {
    if (!iso) return 'just now';
    const s = Math.floor((Date.now() - new Date(iso)) / 1000);
    if (s < 60) return 'just now';
    const m = Math.floor(s / 60); if (m < 60) return m + 'm ago';
    const h = Math.floor(m / 60); if (h < 24) return h + 'h ago';
    return Math.floor(h / 24) + 'd ago';
}
function fmtUp(ms) {
    const s = Math.floor(ms/1000), m = Math.floor(s/60), h = Math.floor(m/60), d = Math.floor(h/24);
    if (d > 0) return d + 'd ' + (h%24) + 'h';
    if (h > 0) return h + 'h ' + (m%60) + 'm';
    return m + 'm';
}
function fmtTime(iso) {
    try { const d = new Date(iso); return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0'); }
    catch(e) { return ''; }
}
function fmtDate(iso) {
    try { return new Date(iso).toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' }); }
    catch(e) { return ''; }
}

/* â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nav(section) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`.nav-item[data-section="${section}"]`)?.classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    $('section-' + section)?.classList.add('active');
    onSection(section);
}
document.querySelectorAll('.nav-item').forEach(b => b.addEventListener('click', () => nav(b.dataset.section)));

function onSection(s) {
    if (s === 'calendar') loadCalendar();
    else if (s === 'email') loadEmail();
    else if (s === 'contacts') loadContacts();
    else if (s === 'tasks') loadTasks();
    else if (s === 'accounts') loadAccounts();
    else if (s === 'scheduler') loadScheduler();
    else if (s === 'memory') loadMemory();
    else if (s === 'supervisor') loadSupervisor();
    else if (s === 'integrations' && S.health) renderIntegrations(S.health);
}

/* â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const socket = io();
socket.on('connect', () => { S.ws = true; setConn('ws-dot', 'ws-label', true, 'Connected'); });
socket.on('disconnect', () => { S.ws = false; setConn('ws-dot', 'ws-label', false, 'Disconnected'); });
socket.on('metrics_update', d => updateMetrics(d));
socket.on('task_update', d => { upsertTask(d.task); renderTasks(); });
socket.on('tasks_list', d => { S.tasks = d.tasks || []; renderTasks(); });

/* â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateMetrics(d) {
    const sys = d.system || {}, svc = d.service || {};
    $('s-cpu').textContent = (sys.cpu_percent || 0).toFixed(1) + '%';
    $('s-ram').textContent = (svc.memory_usage_mb || 0).toFixed(0);
    $('s-rate').textContent = (svc.messages_per_minute || 0).toFixed(1);
    $('s-up').textContent = fmtUp(Date.now() - T0);
    if (sys.platform) $('s-plat').textContent = sys.platform;

    $('r-cpu').textContent = (sys.cpu_percent || 0).toFixed(1) + '%';
    $('r-cpu-bar').style.width = Math.min(sys.cpu_percent || 0, 100) + '%';
    $('r-mem').textContent = (sys.memory_percent || 0).toFixed(1) + '%';
    $('r-mem-bar').style.width = Math.min(sys.memory_percent || 0, 100) + '%';
    $('r-disk').textContent = (sys.disk_percent || 0).toFixed(1) + '%';
    $('r-disk-bar').style.width = Math.min(sys.disk_percent || 0, 100) + '%';

    const netMb = (sys.net_bytes_sent || 0) + (sys.net_bytes_recv || 0);
    if (netMb > 0) {
        const mb = netMb / (1024 * 1024);
        $('r-net').textContent = mb > 1024 ? (mb/1024).toFixed(1) + ' GB' : mb.toFixed(0) + ' MB';
        $('r-net-bar').style.width = Math.min(mb / 100, 100) + '%';
    }
}

/* â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _taskFilter = 'all';
function upsertTask(t) {
    const i = S.tasks.findIndex(x => x.id === t.id);
    if (i >= 0) Object.assign(S.tasks[i], t); else S.tasks.unshift(t);
}
function setTaskFilter(f) {
    _taskFilter = f;
    document.querySelectorAll('.task-filter').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
    renderTasks();
}
async function loadTasks() {
    try {
        const r = await fetch('/api/tasks?limit=100');
        const tasks = await r.json();
        // Merge with existing (keep WS-pushed ones, add API ones)
        for (const t of tasks) {
            const i = S.tasks.findIndex(x => x.id === t.id);
            if (i >= 0) Object.assign(S.tasks[i], t); else S.tasks.push(t);
        }
        // Sort newest first
        S.tasks.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        renderTasks();
    } catch(e) {
        console.error('Failed to load tasks', e);
    }
}
async function cancelTask(id) {
    try {
        await fetch(`/api/tasks/${id}/cancel`, { method: 'POST' });
        const t = S.tasks.find(x => x.id === id);
        if (t) { t.status = 'cancelled'; renderTasks(); }
    } catch(e) { console.error('Cancel failed', e); }
}
function taskDuration(t) {
    if (!t.started_at) return '';
    const end = t.completed_at ? new Date(t.completed_at) : new Date();
    const ms = end - new Date(t.started_at);
    if (ms < 1000) return `${ms}ms`;
    if (ms < 60000) return `${(ms/1000).toFixed(1)}s`;
    return `${Math.floor(ms/60000)}m ${Math.round((ms%60000)/1000)}s`;
}
function renderTasks() {
    const active = S.tasks.filter(t => t.status === 'pending' || t.status === 'running');
    const badge = $('tasks-badge');
    if (active.length > 0) { badge.textContent = active.length; badge.style.display = ''; }
    else badge.style.display = 'none';
    $('s-tasks').textContent = active.length;

    // Dashboard: show active tasks only
    $('dash-tasks').innerHTML = active.length === 0
        ? '<div class="empty"><div class="empty-icon">âš¡</div><div class="empty-title">No active tasks</div></div>'
        : active.slice(0, 5).map(t => taskH(t, true)).join('');

    // Tasks page: apply filter
    let filtered = S.tasks;
    if (_taskFilter !== 'all') filtered = S.tasks.filter(t => t.status === _taskFilter);

    const countEl = $('task-count');
    if (countEl) countEl.textContent = `${filtered.length} of ${S.tasks.length} tasks`;

    $('all-tasks').innerHTML = filtered.length === 0
        ? `<div class="empty"><div class="empty-icon">âš¡</div><div class="empty-title">${_taskFilter === 'all' ? 'No tasks yet' : 'No ' + _taskFilter + ' tasks'}</div><p>Tasks appear as the assistant works</p></div>`
        : filtered.slice(0, 200).map(t => taskH(t, false)).join('');
}
function taskH(t, compact) {
    const dur = taskDuration(t);
    const durStr = dur ? ` Â· ${dur}` : '';
    const canCancel = t.status === 'pending' || t.status === 'running';
    const cancelBtn = !compact && canCancel ? `<button class="task-cancel" onclick="cancelTask('${t.id}')">Cancel</button>` : '';
    const statusTag = !compact ? `<span class="task-status ${t.status}">${t.status}</span>` : '';
    const errorLine = t.error ? `<div class="task-error" title="${esc(t.error)}">âš  ${esc(t.error)}</div>` : '';
    const retryInfo = t.retry_count > 0 ? ` Â· retry ${t.retry_count}/${t.max_retries}` : '';

    return `<div class="task">
        <div class="task-dot ${t.status}"></div>
        <div class="task-body">
            <div class="task-name">${esc(t.name)}</div>
            <div class="task-meta">${t.progress_message || t.status}${durStr} Â· ${timeAgo(t.created_at)}${retryInfo}</div>
            ${errorLine}
        </div>
        <div class="task-actions">
            ${statusTag}
            ${cancelBtn}
        </div>
        <div class="task-prog"><div class="prog-bar"><div class="prog-fill" style="width:${t.progress || 0}%"></div></div><div class="prog-pct">${t.progress || 0}%</div></div>
    </div>`;
}

/* â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function checkHealth() {
    try {
        const r = await fetch('/api/health');
        const d = await r.json();
        S.health = d;
        setConn('api-dot', 'api-label', true, 'Online');

        const llm = d.llm_providers || [];
        setSvc('svc-llm', 'd-llm', llm.length > 0, llm.length ? llm.join(', ') : 'not configured');
        const cal = d.calendar_providers || [];
        setSvc('svc-cal', 'd-cal', cal.length > 0, cal.length ? cal.join(', ') : 'not connected');
        const emailParts = []; if (d.email_imap) emailParts.push('IMAP'); if (d.email_smtp) emailParts.push('SMTP');
        setSvc('svc-email', 'd-email', emailParts.length > 0, emailParts.length ? emailParts.join(' + ') : 'not configured');
        setSvc('svc-tg', 'd-tg', d.telegram, d.telegram ? 'connected' : 'disabled');
        setSvc('svc-wa', 'd-wa', d.whatsapp, d.whatsapp ? 'connected' : 'disabled');
        setSvc('svc-plug', 'd-plug', d.plugins_loaded > 0, (d.plugins_loaded || 0) + ' loaded');
        setSvc('svc-sched', 'd-sched', d.scheduled_tasks > 0, (d.scheduled_tasks || 0) + ' tasks');

        renderIntegrations(d);
    } catch(e) {
        setConn('api-dot', 'api-label', false, 'Offline');
    }
}
function setSvc(lblId, dotId, on, txt) {
    $(lblId).textContent = txt;
    $(dotId).classList.toggle('on', on);
    $(dotId).classList.toggle('off', !on);
    const ic = $(dotId).closest('.svc')?.querySelector('.svc-icon');
    if (ic) { ic.classList.toggle('on', on); ic.classList.toggle('off', !on); }
}

/* â”€â”€ Integrations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderIntegrations(d) {
    const items = [
        { ic:'ğŸ¤–', n:'LLM Providers', s: d.llm_providers?.length ? d.llm_providers.join(', ') : 'Not configured', on: d.llm_providers?.length > 0 },
        { ic:'ğŸ“…', n:'Calendar', s: d.calendar_providers?.length ? d.calendar_providers.join(', ') : 'Not connected', on: d.calendar_providers?.length > 0 },
        { ic:'ğŸ“§', n:'Email (IMAP)', s: d.email_imap ? 'Connected' : 'Not configured', on: d.email_imap },
        { ic:'ğŸ“¤', n:'Email (SMTP)', s: d.email_smtp ? 'Connected' : 'Not configured', on: d.email_smtp },
        { ic:'ğŸ’¬', n:'Telegram', s: d.telegram ? 'Bot active' : 'Disabled', on: d.telegram },
        { ic:'ğŸ“±', n:'WhatsApp', s: d.whatsapp ? 'Connected' : 'Disabled', on: d.whatsapp },
        { ic:'ğŸ”Œ', n:'Plugins', s: (d.plugins_loaded || 0) + ' loaded', on: d.plugins_loaded > 0 },
        { ic:'â°', n:'Scheduled Tasks', s: (d.scheduled_tasks || 0) + ' active', on: d.scheduled_tasks > 0 },
    ];
    $('int-grid').innerHTML = items.map(i => `
        <div class="int-card">
            <div class="int-head">
                <div class="int-icon" style="background:${i.on ? 'var(--green-dim)' : 'var(--bg-3)'}">${i.ic}</div>
                <div><div class="int-title">${i.n}</div><div class="int-desc">${i.s}</div></div>
            </div>
        </div>`).join('');
}

/* â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadCalendar() {
    try {
        const [evR, clR] = await Promise.all([
            fetch('/api/calendar/events?days=7'),
            fetch('/api/calendar/calendars')
        ]);
        const events = await evR.json();
        const cals = await clR.json();

        // Events list
        if (events.length === 0) {
            $('cal-events').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No events in the next 7 days</div></div>';
        } else {
            $('cal-events').innerHTML = events.map(e => {
                const prov = (e.provider || '').replace('CalendarProvider.','');
                const calLabel = e.calendar_name || prov || '';
                const provCls = prov.toLowerCase() || 'caldav';
                return `<div class="evt">
                    <div class="evt-time">${fmtTime(e.start)}</div>
                    <div class="evt-info">
                        <div class="evt-title">${esc(e.title)}</div>
                        <div class="evt-loc">${fmtDate(e.start)}${e.location ? ' &middot; ' + esc(e.location) : ''}</div>
                    </div>
                    ${calLabel ? `<span class="evt-cal evt-cal-${provCls}">${esc(calLabel)}</span>` : ''}
                </div>`;
            }).join('');
        }

        // Dashboard upcoming events
        $('dash-events').innerHTML = events.length === 0
            ? '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No upcoming events</div></div>'
            : events.slice(0, 4).map(e => {
                const prov = (e.provider || '').replace('CalendarProvider.','');
                const calLabel = e.calendar_name || prov || '';
                const provCls = prov.toLowerCase() || 'caldav';
                return `<div class="evt">
                    <div class="evt-time">${fmtTime(e.start)}</div>
                    <div class="evt-info"><div class="evt-title">${esc(e.title)}</div><div class="evt-loc">${fmtDate(e.start)}</div></div>
                    ${calLabel ? `<span class="evt-cal evt-cal-${provCls}">${esc(calLabel)}</span>` : ''}
                </div>`;
            }).join('');

        // Calendar list
        const entries = Object.entries(cals);
        $('cal-list').innerHTML = entries.length === 0
            ? '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No calendars found</div></div>'
            : entries.map(([prov, names]) =>
                names.map(n => `<div class="data-row"><span class="tag tag-blue">${esc(prov)}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(n)}</span></div>`).join('')
              ).join('');
    } catch(e) {
        $('cal-events').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Could not load events</div><p>Calendar may not be configured</p></div>';
        $('cal-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No calendars</div></div>';
        $('dash-events').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Calendar not available</div></div>';
    }
}

/* â”€â”€ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadEmail() {
    try {
        const r = await fetch('/api/email/inbox?limit=30');
        const emails = await r.json();
        if (emails.length === 0) {
            $('email-inbox').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“§</div><div class="empty-title">Inbox is empty</div></div>';
        } else {
            // Count emails per account for summary
            const acctCounts = {};
            emails.forEach(e => { const a = e.account || 'unknown'; acctCounts[a] = (acctCounts[a] || 0) + 1; });
            const acctSummary = Object.entries(acctCounts).map(([k,v]) => `${k}: ${v}`).join(' Â· ');
            const unreadCount = emails.filter(e => !e.is_read).length;
            const summaryEl = document.getElementById('email-summary');
            if (summaryEl) summaryEl.textContent = `${emails.length} emails Â· ${unreadCount} unread Â· ${acctSummary}`;

            $('email-inbox').innerHTML = emails.map(e => {
                const provCls = {'gmail':'tag-red','ews':'tag-amber','imap_smtp':'tag-blue','office365':'tag-purple'}[e.provider] || 'tag-blue';
                const acct = e.account ? `<span class="tag ${provCls}" style="font-size:8px;padding:0 4px;flex-shrink:0">${esc(e.account)}</span>` : '';
                return `<div class="data-row" style="gap:8px">
                    <span style="width:6px;height:6px;border-radius:50%;background:${e.is_read ? 'var(--tx-3)' : 'var(--blue)'};flex-shrink:0"></span>
                    ${acct}
                    <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:${e.is_read ? '400' : '500'}">${esc(e.subject || '(no subject)')}</span>
                    <span style="font-size:10px;color:var(--tx-2);flex-shrink:0">${esc((e.sender || '').split('@')[0])}</span>
                    <span style="font-size:10px;color:var(--tx-3);flex-shrink:0">${fmtDate(e.date)}</span>
                    ${e.has_attachments ? '<span style="font-size:11px">ğŸ“</span>' : ''}
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('email-inbox').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“§</div><div class="empty-title">Could not load inbox</div><p>Email may not be configured</p></div>';
    }
}

/* â”€â”€ Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('contact-q').addEventListener('keydown', e => { if (e.key === 'Enter') loadContacts(); });
async function loadContacts() {
    const q = $('contact-q').value.trim();
    $('contact-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">Loading...</div></div>';
    try {
        const [cR, sR] = await Promise.all([
            fetch(`/api/contacts?query=${encodeURIComponent(q)}&limit=50`),
            fetch('/api/contacts/summary')
        ]);
        const contacts = await cR.json();
        const summary = await sR.json();

        // Summary line
        const parts = [];
        if (summary.total_unique) parts.push(`${summary.total_unique} contacts`);
        if (summary.by_source) {
            const srcs = Object.entries(summary.by_source).filter(([,v]) => v > 0).map(([k,v]) => `${k}: ${v}`);
            if (srcs.length) parts.push(srcs.join(', '));
        }
        if (summary.last_sync) parts.push(`synced ${fmtDate(summary.last_sync)}`);
        $('contact-summary').textContent = parts.join(' Â· ');

        if (contacts.length === 0) {
            $('contact-list').innerHTML = q
                ? `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">No contacts matching "${esc(q)}"</div></div>`
                : '<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">No contacts found</div><p>Click Sync to import from macOS Contacts, WhatsApp, and email</p></div>';
        } else {
            $('contact-list').innerHTML = contacts.map(c => {
                const phones = (c.phones || []).map(p => `<span style="font-size:10px;color:var(--tx-2)">${esc(p.number)}${p.whatsapp ? ' ğŸ’¬' : ''}</span>`).join(' ');
                const emails = (c.emails || []).map(e => `<span style="font-size:10px;color:var(--tx-2)">${esc(e.address)}</span>`).join(' ');
                const srcTags = (c.sources || []).map(s => {
                    const cls = s === 'macos' ? 'tag-blue' : s === 'whatsapp' ? 'tag-green' : s === 'gmail' ? 'tag-red' : 'tag-amber';
                    return `<span class="tag ${cls}" style="font-size:8px;padding:0 4px">${s}</span>`;
                }).join('');
                const company = c.company ? `<span style="font-size:10px;color:var(--tx-3)">${esc(c.company)}</span>` : '';
                return `<div class="data-row" style="flex-direction:column;align-items:flex-start;gap:3px;padding:8px 16px">
                    <div style="display:flex;gap:6px;width:100%;align-items:center">
                        <span style="font-weight:500;flex:1">${esc(c.name)}</span>
                        ${srcTags}
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">${phones} ${emails} ${company}</div>
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('contact-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">Could not load contacts</div></div>';
    }
}

async function syncContacts() {
    $('contact-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”„</div><div class="empty-title">Syncing contacts...</div><p>Importing from macOS Contacts, WhatsApp, and email accounts</p></div>';
    try {
        await fetch('/api/contacts/sync', { method: 'POST' });
        await loadContacts();
    } catch(e) {
        $('contact-list').innerHTML = '<div class="empty"><div class="empty-icon">âŒ</div><div class="empty-title">Sync failed</div></div>';
    }
}

/* â”€â”€ Memory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('mem-q').addEventListener('keydown', e => { if (e.key === 'Enter') searchMemory(); });

function toggleMemoryForm() {
    const f = $('mem-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
    if (f.style.display !== 'none') $('mem-content').focus();
}

async function addMemory() {
    const cat = $('mem-cat').value;
    const content = $('mem-content').value.trim();
    if (!content) return;
    try {
        await fetch('/api/memory/store', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: 'default', category: cat, content, importance: 0.5 }),
        });
        $('mem-content').value = '';
        $('mem-form').style.display = 'none';
        loadMemory();
    } catch(e) { console.error('Store memory failed', e); }
}

async function deleteMemory(id) {
    try {
        await fetch(`/api/memory/${id}`, { method: 'DELETE' });
        loadMemory();
    } catch(e) { console.error('Delete memory failed', e); }
}

function memCatCls(cat) {
    const m = { preference:'tag-purple', fact:'tag-blue', note:'tag-green', project:'tag-amber', contact:'tag-red', habit:'tag-blue' };
    return m[cat] || 'tag-blue';
}

async function loadMemory() {
    try {
        const [listR, statsR] = await Promise.all([
            fetch('/api/memory/list?limit=50'),
            fetch('/api/memory/stats'),
        ]);
        const memories = await listR.json();
        const stats = await statsR.json();

        // Stats
        const cats = Object.entries(stats.categories || {}).map(([k,v]) => `${v} ${k}`).join(' Â· ');
        $('mem-stats').textContent = `${stats.total || 0} memories Â· ${stats.vector_count || 0} vectors${cats ? ' Â· ' + cats : ''}`;

        if (memories.length === 0) {
            $('mem-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-title">No memories stored yet</div><p>Click "+ Add Memory" or tell the assistant to remember something</p></div>';
        } else {
            $('mem-results').innerHTML = memories.map(m => {
                const catCls = memCatCls(m.category);
                const date = m.created_at ? timeAgo(m.created_at) : '';
                const src = m.source ? `<span style="font-size:9px;color:var(--tx-3)">via ${esc(m.source)}</span>` : '';
                return `<div class="data-row" style="flex-direction:column;align-items:flex-start;gap:4px;padding:10px 16px">
                    <div style="display:flex;gap:6px;width:100%;align-items:center">
                        <span class="tag ${catCls}" style="font-size:9px;padding:0 5px">${esc(m.category)}</span>
                        ${src}
                        <span style="font-size:9px;color:var(--tx-3);margin-left:auto">${date}</span>
                        <button class="task-cancel" onclick="deleteMemory('${m.id}')">Delete</button>
                    </div>
                    <div style="font-size:12px;line-height:1.5;color:var(--tx-1);word-break:break-word">${esc(m.content)}</div>
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('mem-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-title">Could not load memories</div></div>';
    }
}

async function searchMemory() {
    const q = $('mem-q').value.trim();
    if (!q) { loadMemory(); return; }
    $('mem-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">Searching...</div></div>';
    try {
        const r = await fetch(`/api/memory/search?query=${encodeURIComponent(q)}&n=10`);
        const results = await r.json();
        if (results.length === 0) {
            $('mem-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-title">No results found</div></div>';
        } else {
            $('mem-results').innerHTML = results.map(m => {
                const dist = m.distance != null ? `<span style="font-size:9px;color:var(--tx-3);margin-left:auto">${((1 - m.distance) * 100).toFixed(0)}% match</span>` : '';
                const cat = (m.metadata && m.metadata.category) || 'general';
                return `<div class="data-row" style="flex-direction:column;align-items:flex-start;gap:4px;padding:10px 16px">
                    <div style="display:flex;gap:6px;width:100%;align-items:center">
                        <span class="tag ${memCatCls(cat)}" style="font-size:9px;padding:0 5px">${esc(cat)}</span>
                        ${dist}
                    </div>
                    <div style="font-size:12px;line-height:1.5;color:var(--tx-1);word-break:break-word">${esc(m.content || '')}</div>
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('mem-results').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-title">Search failed</div></div>';
    }
}

/* â”€â”€ Accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const PROVIDER_FIELDS = {
    ews: [
        { key:'server', label:'Exchange Server Hostname', placeholder:'exchange.company.com' },
        { key:'username', label:'Username (DOMAIN\\\\user or email)', placeholder:'DOMAIN\\\\username' },
        { key:'password', label:'Password', type:'password' },
        { key:'email', label:'Email address', placeholder:'user@company.com' },
    ],
    msgraph: [
        { key:'client_id', label:'Client ID (Application ID)', placeholder:'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx' },
        { key:'client_secret', label:'Client Secret', type:'password' },
        { key:'tenant_id', label:'Tenant ID', placeholder:'common', def:'common' },
    ],
    imap: [
        { key:'imap_server', label:'IMAP Server', placeholder:'imap.gmail.com' },
        { key:'imap_port', label:'IMAP Port', placeholder:'993', def:'993' },
        { key:'username', label:'Username / Email', placeholder:'user@gmail.com' },
        { key:'password', label:'Password / App Password', type:'password' },
        { key:'smtp_server', label:'SMTP Server', placeholder:'smtp.gmail.com' },
        { key:'smtp_port', label:'SMTP Port', placeholder:'587', def:'587' },
    ],
    caldav: [
        { key:'url', label:'CalDAV URL', placeholder:'https://caldav.icloud.com/' },
        { key:'username', label:'Username', placeholder:'user@icloud.com' },
        { key:'password', label:'Password / App Password', type:'password' },
    ],
};

function showAddAccount() { $('acc-form-panel').style.display = ''; $('acc-status').textContent = ''; }
function hideAddAccount() { $('acc-form-panel').style.display = 'none'; }

function updateAccFields() {
    const provider = $('acc-provider').value;
    if (!provider) { $('acc-fields').innerHTML = ''; return; }

    // Google uses a special OAuth flow â€” check if credentials already exist
    if (provider === 'google') {
        $('acc-name-row').style.display = 'none';
        $('acc-default-row').style.display = 'none';
        $('acc-submit-btn').style.display = 'none';
        $('acc-fields').innerHTML = '<div style="font-size:11px;color:var(--tx-2)">Checking Google status...</div>';
        // Check credentials status and show appropriate UI
        fetch('/api/google/credentials-status').then(r => r.json()).then(status => {
            const hasCreds = status.has_credentials;
            const hasToken = status.has_token;
            let html = '';
            if (!hasCreds) {
                html += `
                <div style="background:var(--bg-2);border-radius:var(--r-sm);padding:14px;margin-bottom:12px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px">Step 1: Upload Google OAuth Credentials</div>
                    <p style="font-size:11px;color:var(--tx-2);margin-bottom:10px;line-height:1.5">
                        Download your OAuth2 credentials JSON from
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>.
                        Enable <b>Google Calendar API</b> and <b>Gmail API</b>, then create an OAuth 2.0 Client ID (type: Web application).
                        Add <code>http://localhost:8000/api/google/oauth-callback</code> as an authorized redirect URI.
                    </p>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="file" id="google-creds-file" accept=".json" style="font-size:11px">
                        <button class="btn btn-ghost btn-sm" onclick="uploadGoogleCreds()">Upload</button>
                    </div>
                    <span id="google-upload-status" style="font-size:11px;display:block;margin-top:6px"></span>
                </div>`;
            } else {
                html += `
                <div style="background:var(--bg-2);border-radius:var(--r-sm);padding:14px;margin-bottom:12px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px">âœ” Credentials uploaded</div>
                    <p style="font-size:11px;color:var(--green);margin-bottom:4px">Google OAuth credentials file is already configured.</p>
                    <p style="font-size:10px;color:var(--tx-2)">Want to replace it? <a href="#" onclick="event.preventDefault();document.getElementById('google-reupload').style.display=''">Upload new file</a></p>
                    <div id="google-reupload" style="display:none;margin-top:8px">
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="file" id="google-creds-file" accept=".json" style="font-size:11px">
                            <button class="btn btn-ghost btn-sm" onclick="uploadGoogleCreds()">Upload</button>
                        </div>
                        <span id="google-upload-status" style="font-size:11px;display:block;margin-top:6px"></span>
                    </div>
                </div>`;
            }
            if (hasToken) {
                html += `
                <div style="background:var(--bg-2);border-radius:var(--r-sm);padding:14px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px">âœ” Connected to Google</div>
                    <p style="font-size:11px;color:var(--green);margin-bottom:8px">Google Calendar and Gmail are connected.</p>
                    <button class="btn btn-ghost btn-sm" onclick="startGoogleOAuth()">Re-authenticate</button>
                    <span id="google-oauth-status" style="font-size:11px;margin-left:8px"></span>
                </div>`;
            } else {
                html += `
                <div style="background:var(--bg-2);border-radius:var(--r-sm);padding:14px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px">${hasCreds ? 'Step 2' : 'Step 2'}: Sign in with Google</div>
                    <p style="font-size:11px;color:var(--tx-2);margin-bottom:10px;line-height:1.5">
                        ${hasCreds ? 'Click below to sign in.' : 'After uploading credentials, click below to sign in.'} This will create both Calendar and Gmail accounts automatically.
                    </p>
                    <button class="btn btn-primary btn-sm" onclick="startGoogleOAuth()"${hasCreds ? '' : ' disabled'}>Sign in with Google</button>
                    <span id="google-oauth-status" style="font-size:11px;margin-left:8px"></span>
                </div>`;
            }
            $('acc-fields').innerHTML = html;
        }).catch(() => {
            $('acc-fields').innerHTML = '<div style="color:var(--red);font-size:11px">Could not check Google status</div>';
        });
        return;
    }

    // All other providers: show normal credential fields
    $('acc-name-row').style.display = '';
    $('acc-default-row').style.display = '';
    $('acc-submit-btn').style.display = '';
    const fields = PROVIDER_FIELDS[provider] || [];
    const note = provider === 'ews' ? '<p style="font-size:11px;color:var(--tx-2);margin-bottom:10px">Calendar and Email accounts will both be created automatically.</p>' : '';
    const noteGraph = provider === 'msgraph' ? '<p style="font-size:11px;color:var(--tx-2);margin-bottom:10px">Calendar and Email accounts will both be created automatically.</p>' : '';
    $('acc-fields').innerHTML = (note || noteGraph) + fields.map(f => `
        <div style="margin-bottom:10px">
            <label style="font-size:11px;color:var(--tx-2);display:block;margin-bottom:4px">${f.label}</label>
            <input class="search-input acc-cred" data-key="${f.key}" style="width:100%" type="${f.type || 'text'}" placeholder="${f.placeholder || ''}" value="${f.def || ''}">
        </div>`).join('');
}

async function uploadGoogleCreds() {
    const fileInput = document.getElementById('google-creds-file');
    const status = document.getElementById('google-upload-status');
    if (!fileInput.files.length) { status.textContent = 'Select a file first'; status.style.color = 'var(--red)'; return; }
    const form = new FormData();
    form.append('file', fileInput.files[0]);
    status.textContent = 'Uploading...'; status.style.color = 'var(--tx-2)';
    try {
        const r = await fetch('/api/google/upload-credentials', { method: 'POST', body: form });
        if (!r.ok) { const e = await r.json(); throw new Error(e.detail || 'Upload failed'); }
        status.textContent = 'Credentials uploaded successfully!'; status.style.color = 'var(--green)';
    } catch(e) {
        status.textContent = e.message; status.style.color = 'var(--red)';
    }
}

async function startGoogleOAuth() {
    const status = document.getElementById('google-oauth-status');
    status.textContent = 'Getting auth URL...'; status.style.color = 'var(--tx-2)';
    try {
        const r = await fetch('/api/google/auth-url');
        if (!r.ok) { const e = await r.json(); throw new Error(e.detail || 'Failed'); }
        const d = await r.json();
        window.location.href = d.auth_url;
    } catch(e) {
        status.textContent = e.message; status.style.color = 'var(--red)';
    }
}

async function submitAccount() {
    const provider = $('acc-provider').value;
    const name = $('acc-name').value.trim();
    if (!provider || !name) { $('acc-status').textContent = 'Select a provider and enter a name'; $('acc-status').style.color = 'var(--red)'; return; }

    const creds = {};
    document.querySelectorAll('.acc-cred').forEach(el => { if (el.value.trim()) creds[el.dataset.key] = el.value.trim(); });
    $('acc-status').textContent = 'Validating and connecting...'; $('acc-status').style.color = 'var(--tx-2)';

    try {
        let r;
        if (provider === 'ews') {
            // Combined Exchange endpoint â€” creates both calendar + email
            r = await fetch('/api/accounts/exchange', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, server: creds.server, username: creds.username, password: creds.password, email: creds.email, is_default: $('acc-default').checked })
            });
        } else if (provider === 'msgraph') {
            // Office 365 â€” create calendar + email separately
            r = await fetch('/api/accounts', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name + ' (Calendar)', account_type: 'calendar', provider, credentials: creds, is_default: $('acc-default').checked })
            });
            if (r.ok) {
                await fetch('/api/accounts', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name + ' (Email)', account_type: 'email', provider, credentials: creds, is_default: $('acc-default').checked })
                });
            }
        } else {
            // Single account (IMAP, CalDAV)
            const accType = provider === 'caldav' ? 'calendar' : 'email';
            r = await fetch('/api/accounts', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, account_type: accType, provider, credentials: creds, is_default: $('acc-default').checked })
            });
        }
        if (!r.ok) { const e = await r.json(); throw new Error(e.detail || 'Failed'); }
        $('acc-status').textContent = 'Account(s) added!'; $('acc-status').style.color = 'var(--green)';
        setTimeout(() => { hideAddAccount(); loadAccounts(); }, 1200);
    } catch(e) {
        $('acc-status').textContent = e.message; $('acc-status').style.color = 'var(--red)';
    }
}

async function deleteAccount(id, name) {
    if (!confirm(`Delete account "${name}"?`)) return;
    try {
        await fetch(`/api/accounts/${id}`, { method: 'DELETE' });
        loadAccounts();
    } catch(e) { /* ignore */ }
}

async function loadAccounts() {
    try {
        const r = await fetch('/api/accounts?active_only=false');
        const accs = await r.json();
        if (accs.length === 0) {
            $('acc-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">No accounts configured</div><p>Click "+ Add Account" above to connect a service</p></div>';
        } else {
            const icons = { calendar:'ğŸ“…', email:'ğŸ“§', messaging:'ğŸ’¬' };
            $('acc-list').innerHTML = accs.map(a => `
                <div class="acc">
                    <div class="acc-icon">${icons[a.account_type] || 'ğŸ”‘'}</div>
                    <div class="acc-info">
                        <div class="acc-name">${esc(a.name)}</div>
                        <div class="acc-detail">${esc(a.provider)} &middot; ${esc(a.account_type)}${a.is_default ? ' &middot; <span class="tag tag-blue">default</span>' : ''}</div>
                    </div>
                    <span class="tag ${a.is_active ? 'tag-green' : 'tag-red'}">${a.is_active ? 'active' : 'inactive'}</span>
                    <button class="btn btn-ghost btn-sm" style="padding:3px 8px;font-size:10px;color:var(--red)" onclick="deleteAccount('${a.id}','${esc(a.name)}')">Delete</button>
                </div>`).join('');
        }
    } catch(e) {
        $('acc-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">Could not load accounts</div></div>';
    }
}

// Auto-open accounts section if redirected from Google OAuth
if (new URLSearchParams(window.location.search).get('google') === 'connected') {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelector('[data-section="accounts"]')?.classList.add('active');
    $('section-accounts')?.classList.add('active');
    loadAccounts();
}

/* â”€â”€ Scheduler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function cancelScheduledTask(id) {
    try {
        await fetch(`/api/scheduler/tasks/${id}`, { method: 'DELETE' });
        loadScheduler();
    } catch(e) { console.error('Cancel scheduled task failed', e); }
}
function schedTypeIcon(type) {
    if (type === 'cron') return 'ğŸ”„';
    if (type === 'interval') return 'â±';
    if (type === 'once') return 'ğŸ“Œ';
    return 'â°';
}
function schedTypeCls(type) {
    if (type === 'cron') return 'tag-blue';
    if (type === 'interval') return 'tag-green';
    if (type === 'once') return 'tag-amber';
    return 'tag-blue';
}
async function loadScheduler() {
    try {
        const r = await fetch('/api/scheduler/tasks');
        const tasks = await r.json();

        // Summary
        const cron = tasks.filter(t => t.type === 'cron').length;
        const interval = tasks.filter(t => t.type === 'interval').length;
        const once = tasks.filter(t => t.type === 'once').length;
        const parts = [`${tasks.length} scheduled jobs`];
        if (cron) parts.push(`${cron} cron`);
        if (interval) parts.push(`${interval} interval`);
        if (once) parts.push(`${once} one-time`);
        const totalRuns = tasks.reduce((s, t) => s + (t.run_count || 0), 0);
        if (totalRuns) parts.push(`${totalRuns} total runs`);
        $('sched-summary').textContent = parts.join(' Â· ');

        if (tasks.length === 0) {
            $('sched-list').innerHTML = '<div class="empty"><div class="empty-icon">â°</div><div class="empty-title">No scheduled jobs</div><p>Jobs are created via reminders, cron schedules, and interval tasks</p></div>';
        } else {
            $('sched-list').innerHTML = tasks.map(t => {
                const icon = schedTypeIcon(t.type);
                const typeCls = schedTypeCls(t.type);
                const nextRun = t.next_run ? `Next: ${fmtDate(t.next_run)}` : '';
                const lastRun = t.last_run ? `Last: ${timeAgo(t.last_run)}` : 'Never run';
                const schedule = t.schedule ? esc(t.schedule) : '';
                const funcName = t.func_name ? esc(t.func_name) : '';

                return `<div class="data-row" style="flex-direction:column;align-items:flex-start;gap:4px;padding:10px 16px">
                    <div style="display:flex;gap:8px;width:100%;align-items:center">
                        <span style="font-size:14px">${icon}</span>
                        <span style="font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.name || t.id)}</span>
                        <span class="tag ${typeCls}" style="font-size:8px;padding:0 5px">${esc(t.type)}</span>
                        <button class="task-cancel" onclick="cancelScheduledTask('${t.id}')">Remove</button>
                    </div>
                    <div style="display:flex;gap:12px;font-size:10px;color:var(--tx-2);flex-wrap:wrap">
                        ${schedule ? `<span>ğŸ“‹ ${schedule}</span>` : ''}
                        ${funcName ? `<span>âš™ ${funcName}</span>` : ''}
                        <span>ğŸ”¢ ${t.run_count || 0} runs</span>
                        <span>${lastRun}</span>
                        ${nextRun ? `<span style="color:var(--accent)">${nextRun}</span>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('sched-list').innerHTML = '<div class="empty"><div class="empty-icon">â°</div><div class="empty-title">Could not load scheduler</div></div>';
    }
}

/* â”€â”€ Supervisor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSupervisor() {
    try {
        const r = await fetch('/api/supervisor/status');
        const data = await r.json();

        // Repair state
        const counts = data.repair_counts || {};
        const keys = Object.keys(counts);
        if (keys.length === 0) {
            $('sv-repair-state').innerHTML = '<span style="color:#22c55e">âœ… No active repair cycles â€” system healthy</span>';
        } else {
            $('sv-repair-state').innerHTML = keys.map(k =>
                `<div style="padding:4px 0;border-bottom:1px solid var(--border)">
                    <span style="color:#ef4444">âš </span> <code style="font-size:10px">${esc(k.substring(0,80))}</code>
                    <span class="tag tag-amber" style="font-size:8px;margin-left:6px">${counts[k]}/3 attempts</span>
                </div>`
            ).join('');
        }

        // Learner state
        const learner = data.learner || {};
        if (learner.cycle_count > 0) {
            $('sv-learner-state').innerHTML = `
                <div style="display:flex;gap:16px;flex-wrap:wrap">
                    <span>ğŸ§  <strong>${learner.cycle_count}</strong> cycles</span>
                    <span>âœ… <strong>${learner.improvements_applied || 0}</strong> improvements applied</span>
                    <span>âŒ <strong>${learner.failed_ideas || 0}</strong> skipped ideas</span>
                    ${learner.last_updated ? `<span style="color:var(--tx-3)">Last: ${learner.last_updated.substring(0,19).replace('T',' ')}</span>` : ''}
                </div>`;
            const recent = learner.recent_improvements || [];
            if (recent.length > 0) {
                $('sv-learner-improvements').innerHTML = '<div style="margin-top:4px;color:var(--tx-3);font-size:10px">Recent:</div>' +
                    recent.reverse().map(i => `<div style="padding:2px 0;font-size:10px">
                        <span class="tag tag-green" style="font-size:8px;padding:0 4px">${esc(i.type || 'improvement')}</span>
                        ${esc((i.description || '').substring(0,80))}
                    </div>`).join('');
            }
        } else {
            $('sv-learner-state').innerHTML = '<span style="color:var(--tx-3)">No learning cycles yet â€” runs automatically every hour when supervisor is active</span>';
        }

        // Audit summary
        $('sv-audit-summary').textContent = `${data.audit_total || 0} total entries` +
            (data.last_updated ? ` Â· Last updated: ${data.last_updated}` : '');

        // Audit log
        const entries = data.audit_recent || [];
        if (entries.length === 0) {
            $('sv-audit-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§¬</div><div class="empty-title">No activity yet</div><p>Start the supervisor or use /improve to see activity here</p></div>';
        } else {
            $('sv-audit-list').innerHTML = entries.reverse().map(e => {
                const ts = (e.timestamp || '').substring(0, 19).replace('T', ' ');
                const action = e.action || 'unknown';
                const color = action.includes('success') ? '#22c55e' :
                              action.includes('fail') || action.includes('error') || action.includes('crash') ? '#ef4444' :
                              action.includes('rollback') ? '#f59e0b' : 'var(--tx-2)';
                const details = Object.keys(e).filter(k => k !== 'timestamp' && k !== 'action')
                    .map(k => `${k}=${JSON.stringify(e[k]).substring(0,60)}`).join(' ');
                return `<div style="padding:4px 0;border-bottom:1px solid var(--border);line-height:1.4">
                    <span style="color:var(--tx-3)">${esc(ts)}</span>
                    <span style="color:${color};font-weight:600"> ${esc(action)}</span>
                    ${details ? `<span style="color:var(--tx-3);font-size:10px"> ${esc(details.substring(0,120))}</span>` : ''}
                </div>`;
            }).join('');
        }
    } catch(e) {
        $('sv-repair-state').innerHTML = '<span style="color:var(--tx-3)">Could not load supervisor status</span>';
        $('sv-audit-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§¬</div><div class="empty-title">Supervisor not available</div></div>';
    }
    // Also load the improvement queue
    loadQueue();
}

async function triggerLearnCycle() {
    const btn = $('learn-btn');
    const result = $('learn-result');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    result.style.display = 'block';
    result.innerHTML = '<span style="color:var(--accent)">ğŸ§  Reading logs, conversations, and errors... this may take a minute.</span>';

    try {
        const r = await fetch('/api/supervisor/learn', { method: 'POST' });
        const data = await r.json();
        const parts = [];
        parts.push(`Signals: ${data.signals_gathered || 0}`);
        parts.push(`Proposals: ${data.proposals || 0}`);
        parts.push(`Applied: ${data.improvements_applied || 0}`);
        if (data.improvements_failed) parts.push(`Failed: ${data.improvements_failed}`);
        if (data.new_version) parts.push(`Version: v${data.new_version}`);
        const color = (data.improvements_applied || 0) > 0 ? '#22c55e' : 'var(--tx-2)';
        result.innerHTML = `<span style="color:${color}">Cycle #${data.cycle || '?'} complete â€” ${parts.join(' Â· ')}</span>`;
        loadSupervisor();
    } catch(e) {
        result.innerHTML = `<span style="color:#ef4444">âŒ ${esc(e.message)}</span>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Cycle Now';
    }
}

async function submitImprove() {
    const input = $('improve-input');
    const btn = $('improve-btn');
    const result = $('improve-result');
    const request = input.value.trim();
    if (!request) return;

    btn.disabled = true;
    btn.textContent = 'Queueing...';
    result.style.display = 'block';
    result.innerHTML = '<span style="color:var(--accent)">ğŸ§¬ Adding to improvement queue...</span>';

    try {
        const r = await fetch('/api/supervisor/improve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request })
        });
        const data = await r.json();
        if (data.queued) {
            result.innerHTML = `<span style="color:#22c55e">âœ… ${esc(data.message)}</span><br><small style="color:var(--tx-3)">${data.position} item(s) in queue. Worker processes them in order.</small>`;
            input.value = '';
            loadQueue();
        } else {
            result.innerHTML = `<span style="color:#ef4444">âŒ ${esc(data.message || data.error)}</span>`;
        }
    } catch(e) {
        result.innerHTML = `<span style="color:#ef4444">âŒ Error: ${esc(e.message)}</span>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Improve';
    }
}

async function loadQueue() {
    try {
        const r = await fetch('/api/supervisor/queue');
        const data = await r.json();
        const stats = data.stats || {};
        const running = data.worker_running;

        // Update worker toggle button
        $('queue-toggle-btn').textContent = running ? 'Stop Worker' : 'Start Worker';
        $('queue-worker-status').innerHTML = running
            ? '<span style="color:#22c55e">â— Running</span>'
            : '<span style="color:var(--tx-3)">â— Stopped</span>';

        // Stats bar
        const parts = [];
        if (stats.pending) parts.push(`â³ ${stats.pending} pending`);
        if (stats.in_progress) parts.push(`ğŸ”„ ${stats.in_progress} in progress`);
        if (stats.completed) parts.push(`âœ… ${stats.completed} completed`);
        if (stats.failed) parts.push(`âŒ ${stats.failed} failed`);
        $('queue-stats').innerHTML = parts.length ? parts.join(' Â· ') : 'Queue empty';

        // Item list
        const items = (data.items || []).slice().reverse();
        if (items.length === 0) {
            $('queue-list').innerHTML = '<div class="empty" style="padding:12px"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No items in queue</div><p style="font-size:10px">Use the form above or let the learner auto-add observations</p></div>';
            return;
        }

        $('queue-list').innerHTML = items.map(i => {
            const statusColors = {
                pending: '#f59e0b', in_progress: '#3b82f6',
                completed: '#22c55e', failed: '#ef4444', skipped: 'var(--tx-3)'
            };
            const statusIcons = {
                pending: 'â³', in_progress: 'ğŸ”„',
                completed: 'âœ…', failed: 'âŒ', skipped: 'â­'
            };
            const color = statusColors[i.status] || 'var(--tx-2)';
            const icon = statusIcons[i.status] || 'â€¢';
            const ts = (i.created_at || '').substring(0, 16).replace('T', ' ');
            const cancelBtn = i.status === 'pending'
                ? `<button class="btn btn-ghost btn-sm" onclick="cancelQueueItem('${i.id}')" style="font-size:9px;padding:1px 4px;margin-left:4px">Cancel</button>`
                : '';
            const resultMsg = i.result_message
                ? `<div style="font-size:10px;color:var(--tx-3);margin-top:2px;padding-left:18px">${esc(i.result_message.substring(0, 120))}</div>`
                : '';
            const sourceTag = i.source !== 'user'
                ? `<span class="tag" style="font-size:8px;padding:0 4px;background:var(--bg-3);margin-left:4px">${esc(i.source)}</span>`
                : '';

            return `<div style="padding:6px 0;border-bottom:1px solid var(--border)">
                <div style="display:flex;align-items:center;gap:4px">
                    <span>${icon}</span>
                    <span style="flex:1">${esc(i.request.substring(0, 80))}${i.request.length > 80 ? '...' : ''}</span>
                    ${sourceTag}
                    <span style="color:${color};font-size:10px;font-weight:600">${esc(i.status)}</span>
                    ${cancelBtn}
                </div>
                <div style="font-size:9px;color:var(--tx-3);padding-left:18px">${ts} Â· #${i.id}</div>
                ${resultMsg}
            </div>`;
        }).join('');
    } catch(e) {
        $('queue-stats').innerHTML = '<span style="color:var(--tx-3)">Could not load queue</span>';
    }
}

async function cancelQueueItem(itemId) {
    try {
        await fetch(`/api/supervisor/queue/${itemId}/cancel`, { method: 'POST' });
        loadQueue();
    } catch(e) {
        console.error('Cancel failed', e);
    }
}

async function toggleQueueWorker() {
    const btn = $('queue-toggle-btn');
    const isRunning = btn.textContent.includes('Stop');
    btn.disabled = true;
    try {
        const endpoint = isRunning ? '/api/supervisor/queue/stop' : '/api/supervisor/queue/start';
        await fetch(endpoint, { method: 'POST' });
        await loadQueue();
    } catch(e) {
        console.error('Toggle worker failed', e);
    } finally {
        btn.disabled = false;
    }
}

/* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const chatIn = $('chat-input'), chatBtn = $('chat-send'), chatBox = $('chat-messages');

chatIn.addEventListener('input', () => {
    chatIn.style.height = 'auto';
    chatIn.style.height = Math.min(chatIn.scrollHeight, 100) + 'px';
    chatBtn.disabled = !chatIn.value.trim() || S.chatBusy;
});
chatIn.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});
chatBtn.addEventListener('click', sendChat);

async function sendChat() {
    const text = chatIn.value.trim();
    if (!text || S.chatBusy) return;

    addMsg('user', text);
    chatIn.value = ''; chatIn.style.height = 'auto';
    chatBtn.disabled = true; S.chatBusy = true;

    const typ = document.createElement('div');
    typ.className = 'chat-msg chat-typing assistant';
    typ.innerHTML = '<div class="chat-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    chatBox.appendChild(typ);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        const r = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, user_id: 'dashboard', channel: 'dashboard' })
        });
        const d = await r.json();
        typ.remove();
        addMsg('assistant', d.response || d.detail || 'No response');
    } catch(e) {
        typ.remove();
        addMsg('assistant', 'Error: Could not reach the API. Is Koda2 running?');
    } finally {
        S.chatBusy = false;
        chatBtn.disabled = !chatIn.value.trim();
    }
}

function addMsg(role, text) {
    const now = new Date();
    const ts = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    const div = document.createElement('div');
    div.className = 'chat-msg ' + role;
    div.innerHTML = `<div class="chat-bubble">${esc(text)}</div><div class="chat-time">${ts}</div>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* â”€â”€ Refresh / Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function refreshAll() {
    checkHealth();
    loadCalendar();
    if (S.ws) socket.emit('refresh_request');
}

// Initial loads
checkHealth();
loadCalendar();
renderTasks();

// Periodic updates
setInterval(checkHealth, 30000);
setInterval(() => { $('s-up').textContent = fmtUp(Date.now() - T0); }, 60000);
// Auto-refresh tasks every 10s when tasks section is active
setInterval(() => {
    if (document.querySelector('#section-tasks.active')) loadTasks();
}, 10000);
</script>
</body>
</html>
